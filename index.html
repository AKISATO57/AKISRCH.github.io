<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKISATO灯塔</title>
    <meta name="description" content="简洁、美观、可自定义的二次元导航站">
    
    <!-- 默认浏览器标签页图标 (初始占位) -->
    <link id="dynamic-favicon" rel="icon" href="https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEJ8HRpHjs80LFuF_yfs2Avw8wPzD918gACRjcAAtPG8VTjbO0fkjB6CDYE.png" type="image/png">
    
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700;800;900&family=Nunito:wght@600;700;800;900&family=Quicksand:wght@500;700&family=Dosis:wght@500;700&display=swap" rel="stylesheet">

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 配置 Tailwind 样式 -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Nunito"', '"M PLUS Rounded 1c"', 'sans-serif'],
                    },
                    colors: {
                        anime: {
                            pink: '#ff7eb3',
                            blue: '#64d2ff',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob-left': 'blob-left 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1)',
                        'blob-right': 'blob-right 28s infinite alternate-reverse cubic-bezier(0.4, 0, 0.2, 1)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        'blob-left': {
                            '0%': { transform: 'translate(0, 0) scale(1)' },
                            '33%': { transform: 'translate(80px, 150px) scale(1.4)' },
                            '66%': { transform: 'translate(-40px, 80px) scale(0.9)' },
                            '100%': { transform: 'translate(20px, -20px) scale(1.1)' }
                        },
                        'blob-right': {
                            '0%': { transform: 'translate(0, 0) scale(1)' },
                            '33%': { transform: 'translate(-100px, -120px) scale(1.3)' },
                            '66%': { transform: 'translate(50px, -60px) scale(0.8)' },
                            '100%': { transform: 'translate(-20px, 20px) scale(1)' }
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(100, 210, 255, 0.5), 0 0 30px rgba(100, 210, 255, 0.3)',
                        'search-hover': '0 10px 40px -10px rgba(100, 210, 255, 0.4)',
                    }
                }
            }
        }
    </script>

    <!-- 引入 Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react,react-dom"
        }
    }
    </script>

    <style>
        html { scroll-behavior: smooth; }
        body {
            min-height: 100vh;
            font-family: 'Nunito', 'M PLUS Rounded 1c', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        ul, li, ol {
            list-style: none !important;
            margin: 0;
            padding: 0;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(150, 150, 150, 0.5); }
        * { -webkit-tap-highlight-color: transparent; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            --glass-opacity: 0.2;
            --glass-blur: 25px;
            background: rgba(255, 255, 255, var(--glass-opacity));
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            isolation: isolate; 
        }

        body.blur-loaded .glass-panel {
            backdrop-filter: blur(var(--glass-blur)) saturate(120%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(120%);
            transition: backdrop-filter 1s ease, -webkit-backdrop-filter 1s ease, border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .dark .glass-panel {
            background: rgba(0, 0, 0, calc(var(--glass-opacity) + 0.2));
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .hover-glow:hover {
            background: rgba(255, 255, 255, calc(var(--glass-opacity) + 0.1));
            box-shadow: 0 0 25px rgba(100, 210, 255, 0.35);
            border-color: rgba(100, 210, 255, 0.3);
            z-index: 10;
        }
        .dark .hover-glow:hover {
            background: rgba(0, 0, 0, calc(var(--glass-opacity) + 0.3));
            box-shadow: 0 0 25px rgba(100, 210, 255, 0.15);
            border-color: rgba(100, 210, 255, 0.2);
        }

        /* --- Slider --- */
        .slider-container {
            position: relative;
            width: 100%;
            height: 24px;
            display: flex;
            align-items: center;
        }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            z-index: 2;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 24px;
            cursor: pointer;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 36px;
            border-radius: 999px;
            background: #3b82f6;
            cursor: pointer;
            margin-top: 2px; 
            margin-left: 2px;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
            transition: transform 0.2s, background-color 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { background: #60a5fa; transform: scale(1.05); }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(0.95); background: #2563eb; }

        /* --- Custom Color Popover Styles --- */
        .color-trigger {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
            overflow: hidden; 
            transition: transform 0.2s;
            background-size: 100% 100%;
            -webkit-mask-image: -webkit-radial-gradient(white, black);
        }
        .color-trigger:hover { transform: scale(1.1); border-color: white; }
        
        .color-trigger.is-transparent {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
        }

        .default-text-overlay {
            border-radius: 50%;
            overflow: hidden;
        }

        .shadow-text-super { text-shadow: 0 2px 5px rgba(0,0,0,0.7); }
        .shadow-text-solid { text-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }
        .dark .shadow-text-solid { text-shadow: 0 3px 6px rgba(0, 0, 0, 0.8); }
        .shadow-text-gradient { filter: drop-shadow(0 4px 8px rgba(96, 165, 250, 0.4)); }

        .engine-icon-btn {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; border-radius: 50%;
            cursor: pointer; transition: all 0.2s; flex-shrink: 0;
        }
        .engine-icon-btn:hover { transform: scale(1.1); z-index: 10; background-color: rgba(255, 255, 255, 0.2); }
        
        .engine-selected { background-color: transparent; border: 1px solid transparent; }
        .engine-unselected { background-color: transparent; border: 1px solid transparent; }

        ::view-transition-old(root), ::view-transition-new(root) { animation: none; mix-blend-mode: normal; display: block; }
        ::view-transition-new(root) { z-index: 9999; }
        ::view-transition-old(root) { z-index: 1; }
        .file-input { display: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 overflow-x-hidden selection:bg-pink-200 selection:text-pink-900 dark:selection:bg-pink-900 dark:selection:text-pink-100 select-none transition-colors duration-300" ondragstart="return false;">
    <div id="root" class="min-h-screen"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createPortal } from 'react-dom';
        import { motion, useSpring, useMotionValue, AnimatePresence } from 'framer-motion';
        import { 
            Search, Plus, Trash2, Settings, X, Moon, Sun, 
            LayoutGrid, Image as ImageIcon, RotateCcw, RotateCw,
            Check, Sparkles, Clock, Palette, Sliders, GripHorizontal, Edit3, Upload, Link as LinkIcon,
            Monitor, Layout, Type, ArrowUp, MousePointer2, ChevronDown, Droplet, Eye, User, Frame, MousePointer,
            Clipboard, Copy, Scissors, ArrowRightCircle, CheckSquare
        } from 'lucide-react';

        // --- 全局动画参数 ---
        const JELLY_SPRING = { type: "spring", stiffness: 400, damping: 12, mass: 0.8 };
        const HOVER_TARGET = { scale: 1.12, y: -5, rotate: 1, transition: JELLY_SPRING };

        const CONTAINER_VARIANTS = {
            hidden: { opacity: 0 },
            visible: { opacity: 1, transition: { staggerChildren: 0.05, delayChildren: 0.1 } }
        };

        const ITEM_VARIANTS = {
            hidden: { opacity: 0, y: 20, scale: 0.95 }, 
            visible: { 
                opacity: 1, 
                y: 0, 
                scale: 1,
                transition: { 
                    duration: 0.6,
                    ease: [0.22, 1, 0.36, 1] 
                } 
            }
        };

        // --- 默认配置 ---
        const DEFAULT_BG = ''; 
        const DEFAULT_AVATAR = 'https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEJ8HRpHjs80LFuF_yfs2Avw8wPzD918gACRjcAAtPG8VTjbO0fkjB6CDYE.png';
        
        const PRESET_BGS = [
            { id: 'default', name: '简约白', value: '', previewColor: 'bg-gradient-to-br from-blue-100 to-pink-100' },
            { id: 'img1', name: '唯美 01', value: 'https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEKYLlpIASP-TeQ97ONpgHt4Tsy-mZJpgAC7zYAAlVBAVU3vrmyI3gFFzYE.jpg' },
            { id: 'img2', name: '唯美 02', value: 'https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEKYMdpIATJlmkGIRvHD-dw25EzOIYVcAACAjcAAlVBAVVdBElS6u54wTYE.jpg' }
        ];

        const DEFAULT_LINKS = [
            { id: '6', title: 'AKIHOME', url: 'https://akihm.netlify.app', desc: '我的主页', iconUrl: 'https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEJ8HRpHjs80LFuF_yfs2Avw8wPzD918gACRjcAAtPG8VTjbO0fkjB6CDYE.png', visitCount: 0 },
            { id: '1', title: 'Google', url: 'https://www.google.com', desc: '遇到问题先问我', visitCount: 0 },
            { id: '2', title: 'Bilibili', url: 'https://www.bilibili.com', desc: '干杯 ( ゜- ゜)つロ', visitCount: 0 },
            { id: '3', title: 'GitHub', url: 'https://github.com', desc: '全球最大开源社区', visitCount: 0 },
            { id: '4', title: 'ChatGPT', url: 'https://chat.openai.com', desc: '遇事不决问AI', visitCount: 0 },
            { id: '5', title: 'Youtube', url: 'https://www.youtube.com', desc: '摸鱼圣地', visitCount: 0 },
        ];

        const DEFAULT_LAYOUT = {
            showTitle: true,
            searchPos: 'center', 
            text1: 'AKISATO',
            particleText: 'の',
            text2: '灯塔',
            gridTop_top: 0,    
            gridTop_center: 0,
            showCollections: true, 
            cardSize: 100, 
            cardGap: 3 
        };

        const DEFAULT_VISUALS = {
            enableCursor: true,
            enableParticles: true,
            enableDynamicBlobs: true 
        };

        // --- 图标 ---
        const GoogleLogo = () => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", width: "24", height: "24" }, React.createElement("path", { d: "M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z", fill: "#4285F4" }), React.createElement("path", { d: "M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z", fill: "#34A853" }), React.createElement("path", { d: "M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z", fill: "#FBBC05" }), React.createElement("path", { d: "M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z", fill: "#EA4335" }));
        const BingLogo = () => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", width: "24", height: "24", fill: "currentColor", className: "text-[#00809d]" }, React.createElement("path", { d: "M10.1 2.3L4.7 4.1v14.3l7.6 4.4 8-4.8V7.4L10.1 2.3zm.9 3.9l3.6 2.1v6.1l-3.6 2V6.2z" }));
        const GoogleAILogo = () => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", width: "24", height: "24", fill: "none" },
            React.createElement("path", { d: "M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10 5.35 0 9.25-3.67 9.25-9.09 0-1.15-.15-1.81-.15-1.81z", fill: "url(#ai-gradient)" }),
            React.createElement("defs", null, 
                React.createElement("linearGradient", { id: "ai-gradient", x1: "2", y1: "2", x2: "22", y2: "22", gradientUnits: "userSpaceOnUse" },
                    React.createElement("stop", { offset: "0%", stopColor: "#4285F4" }),
                    React.createElement("stop", { offset: "50%", stopColor: "#9b59b6" }),
                    React.createElement("stop", { offset: "100%", stopColor: "#ff7eb3" })
                )
            )
        );

        const SEARCH_ENGINES = [
            { id: 'google', name: 'Google', url: 'https://www.google.com/search?q=', logo: GoogleLogo },
            { id: 'google_ai', name: 'Google AI', url: 'https://www.google.com/search?udm=50&q=', logo: GoogleAILogo },
            { id: 'bing', name: 'Bing', url: 'https://tw.bing.com/search?mkt=zh-TW&q=', logo: BingLogo }
        ];

        // --- Color Utilities ---
        const hexToHsv = (hex) => {
            let r = 0, g = 0, b = 0;
            if (!hex) return { h: 0, s: 0, v: 100 }; 
            if (hex.startsWith('#')) hex = hex.slice(1);
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16); g = parseInt(hex[1] + hex[1], 16); b = parseInt(hex[2] + hex[2], 16);
            } else if (hex.length >= 6) {
                r = parseInt(hex.substring(0, 2), 16); g = parseInt(hex.substring(2, 4), 16); b = parseInt(hex.substring(4, 6), 16);
            }
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) h = 0;
            else {
                switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, v: v * 100 };
        };
        const hsvToHex = (h, s, v) => {
            let r, g, b, i, f, p, q, t;
            h = Math.max(0, Math.min(360, h)); s = Math.max(0, Math.min(100, s)) / 100; v = Math.max(0, Math.min(100, v)) / 100;
            if(s === 0) { r = g = b = v; } else {
                h /= 60; i = Math.floor(h); f = h - i; p = v * (1 - s); q = v * (1 - s * f); t = v * (1 - s * (1 - f));
                switch(i) { case 0: r = v; g = t; b = p; break; case 1: r = q; g = v; b = p; break; case 2: r = p; g = v; b = t; break; case 3: r = p; g = q; b = v; break; case 4: r = t; g = p; b = v; break; default: r = v; g = p; b = q; }
            }
            const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        };

        // --- Improved Context Menu Component ---
        const CustomContextMenu = ({ 
            visible, x, y, onClose, 
            onPaste, onPasteAndSearch, onCopy, onCut, onDelete, onSelectAll,
            onUndo, onRedo, canUndo, canRedo,
            hasSelection, glassSettings 
        }) => {
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (menuRef.current && !menuRef.current.contains(e.target)) {
                        onClose();
                    }
                };
                if (visible) {
                    document.addEventListener('mousedown', handleClickOutside);
                    document.addEventListener('scroll', onClose, { capture: true }); 
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                    document.removeEventListener('scroll', onClose, { capture: true });
                };
            }, [visible, onClose]);

            // Adjust position to stay in viewport
            const style = useMemo(() => {
                if (!visible) return { display: 'none' };
                let left = x;
                let top = y;
                const width = 240; // Approx width
                const height = 350; // Increased height for more items
                if (left + width > window.innerWidth) left = window.innerWidth - width - 10;
                if (top + height > window.innerHeight) top = window.innerHeight - height - 10;
                
                return { 
                    position: 'fixed', 
                    left: left, 
                    top: top, 
                    zIndex: 99999,
                    '--glass-opacity': (glassSettings?.opacity || 0.2) + 0.4,
                    '--glass-blur': (glassSettings?.blur || 25) + 'px'
                };
            }, [visible, x, y, glassSettings]);

            if (!visible) return null;

            const MenuItem = ({ onClick, icon: Icon, label, shortcut, disabled, destructive }) => (
                React.createElement("button", {
                    onClick: onClick, 
                    disabled: disabled,
                    className: `flex items-center justify-between px-3 py-2 mx-1 rounded-lg transition-all
                        ${disabled 
                            ? 'opacity-40 cursor-not-allowed' 
                            : destructive
                                ? 'hover:bg-red-500/10 hover:text-red-500 text-slate-700 dark:text-slate-200'
                                : 'hover:bg-blue-500/10 hover:text-blue-500 text-slate-700 dark:text-slate-200'
                        }`
                },
                    React.createElement("div", { className: "flex items-center gap-2.5" },
                        Icon && React.createElement(Icon, { size: 15, strokeWidth: 2.5 }),
                        React.createElement("span", { className: "text-sm font-bold" }, label)
                    ),
                    shortcut && React.createElement("span", { className: "text-[10px] opacity-50 font-bold font-mono" }, shortcut)
                )
            );

            return createPortal(
                React.createElement(motion.div, {
                    initial: { opacity: 0, scale: 0.8, filter: "blur(10px)" },
                    animate: { opacity: 1, scale: 1, filter: "blur(0px)" },
                    exit: { opacity: 0, scale: 0.8, filter: "blur(10px)" },
                    transition: { type: "spring", stiffness: 400, damping: 25 },
                    ref: menuRef,
                    style: style,
                    className: "glass-panel w-56 rounded-2xl shadow-2xl py-2 flex flex-col overflow-hidden select-none border border-white/20 dark:border-white/10",
                    onMouseDown: (e) => e.preventDefault() // Prevents focus loss on input when clicking menu
                },
                    // Header
                    React.createElement("div", { className: "px-4 py-1.5 text-[10px] text-slate-400 dark:text-slate-500 font-extrabold uppercase tracking-widest mb-1 ml-1" }, "菜单"),
                    
                    React.createElement("div", { className: "flex items-center px-1 mb-1" },
                        React.createElement("button", { 
                            onClick: onUndo, 
                            disabled: !canUndo,
                            className: `flex-1 flex flex-col items-center justify-center p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 transition-colors ${!canUndo ? 'opacity-30 cursor-not-allowed' : 'text-slate-700 dark:text-slate-200'}`
                        }, React.createElement(RotateCcw, { size: 16 }), React.createElement("span", { className: "text-[10px] mt-1 font-bold" }, "撤销")),
                        React.createElement("div", { className: "w-px h-8 bg-slate-200 dark:bg-white/10 mx-1" }),
                        React.createElement("button", { 
                            onClick: onRedo, 
                            disabled: !canRedo,
                            className: `flex-1 flex flex-col items-center justify-center p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/10 transition-colors ${!canRedo ? 'opacity-30 cursor-not-allowed' : 'text-slate-700 dark:text-slate-200'}`
                        }, React.createElement(RotateCw, { size: 16 }), React.createElement("span", { className: "text-[10px] mt-1 font-bold" }, "重做"))
                    ),

                    React.createElement("div", { className: "h-px bg-slate-200 dark:bg-white/10 my-1 mx-2" }),

                    React.createElement(MenuItem, { onClick: onCut, icon: Scissors, label: "剪切", shortcut: "Ctrl+X", disabled: !hasSelection }),
                    React.createElement(MenuItem, { onClick: onCopy, icon: Copy, label: "复制", shortcut: "Ctrl+C", disabled: !hasSelection }),
                    React.createElement(MenuItem, { onClick: onPaste, icon: Clipboard, label: "粘贴", shortcut: "Ctrl+V" }),
                    React.createElement(MenuItem, { onClick: onPasteAndSearch, icon: ArrowRightCircle, label: "粘贴并搜索", shortcut: "Go" }),
                    React.createElement(MenuItem, { onClick: onDelete, icon: Trash2, label: "删除", destructive: true, disabled: !hasSelection }),

                    React.createElement("div", { className: "h-px bg-slate-200 dark:bg-white/10 my-1 mx-2" }),

                    React.createElement(MenuItem, { onClick: onSelectAll, icon: CheckSquare, label: "全选", shortcut: "Ctrl+A" })

                ),
                document.body
            );
        };

        // --- Color Picker Components ---
        const SaturationBrightnessPicker = ({ hue, saturation, value, onChange }) => {
            const containerRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const handleMove = useCallback((clientX, clientY) => {
                if (!containerRef.current) return;
                const rect = containerRef.current.getBoundingClientRect();
                let x = Math.max(0, Math.min(clientX - rect.left, rect.width));
                let y = Math.max(0, Math.min(clientY - rect.top, rect.height));
                onChange((x / rect.width) * 100, 100 - (y / rect.height) * 100);
            }, [onChange]);
            useEffect(() => {
                const onMouseMove = (e) => { if (isDragging) handleMove(e.clientX, e.clientY); };
                const onMouseUp = () => setIsDragging(false);
                if (isDragging) { window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp); }
                return () => { window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); };
            }, [isDragging, handleMove]);
            return React.createElement("div", { ref: containerRef, onMouseDown: (e) => { setIsDragging(true); handleMove(e.clientX, e.clientY); }, className: "w-full h-32 rounded-lg cursor-crosshair relative overflow-hidden mb-3 shadow-inner", style: { backgroundColor: `hsl(${hue}, 100%, 50%)`, backgroundImage: 'linear-gradient(to right, #fff, transparent), linear-gradient(to top, #000, transparent)' } },
                React.createElement("div", { className: "absolute w-3 h-3 border-2 border-white rounded-full shadow-[0_0_2px_rgba(0,0,0,0.5)] pointer-events-none transform -translate-x-1/2 -translate-y-1/2", style: { left: `${saturation}%`, top: `${100 - value}%` } })
            );
        };
        const HueSlider = ({ hue, onChange }) => {
            const containerRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const handleMove = useCallback((clientX) => {
                if (!containerRef.current) return;
                const rect = containerRef.current.getBoundingClientRect();
                let x = Math.max(0, Math.min(clientX - rect.left, rect.width));
                onChange((x / rect.width) * 360);
            }, [onChange]);
            useEffect(() => {
                const onMouseMove = (e) => { if (isDragging) handleMove(e.clientX); };
                const onMouseUp = () => setIsDragging(false);
                if (isDragging) { window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp); }
                return () => { window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); };
            }, [isDragging, handleMove]);
            return React.createElement("div", { ref: containerRef, onMouseDown: (e) => { setIsDragging(true); handleMove(e.clientX); }, className: "w-full h-4 rounded-full cursor-pointer relative mb-3 shadow-inner", style: { background: 'linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%)' } },
                React.createElement("div", { className: "absolute w-4 h-4 bg-white border border-slate-300 rounded-full shadow-sm transform -translate-y-0 pointer-events-none", style: { left: `calc(${hue / 360 * 100}% - 8px)` } })
            );
        };
        const ColorPickerPopover = ({ color, onChange, onClose, triggerRect }) => {
            const presetColors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#000000'];
            const presetGradients = ['linear-gradient(to right, #60a5fa, #f472b6)', 'linear-gradient(to right, #3b82f6, #8b5cf6)', 'linear-gradient(to right, #f97316, #f59e0b)', 'linear-gradient(to right, #10b981, #06b6d4)', 'linear-gradient(to right, #ff7eb3, #ff758c)', 'linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%)'];
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [hsv, setHsv] = useState(() => hexToHsv(color || '#000000'));
            const updateColorFromHsv = (newH, newS, newV) => { const newHex = hsvToHex(newH, newS, newV); setHsv({ h: newH, s: newS, v: newV }); onChange(newHex); };
            const style = useMemo(() => {
                if (!triggerRect) return { position: 'fixed', left: '50%', top: '50%', transform: 'translate(-50%, -50%)', zIndex: 9999 };
                const w = 260, h = showAdvanced ? 500 : 400, vw = window.innerWidth, vh = window.innerHeight, p = 10;
                let l = triggerRect.left + triggerRect.width / 2 - w / 2, t = triggerRect.bottom + p;
                if (l < p) l = p; else if (l + w > vw - p) l = vw - w - p;
                if (t + h > vh - p) { t = triggerRect.top - h - p > 0 ? triggerRect.top - h - p : Math.max(p, vh - h - p); }
                return { position: 'fixed', left: `${l}px`, top: `${t}px`, zIndex: 9999 };
            }, [triggerRect, showAdvanced]);
            return createPortal(
                React.createElement(motion.div, { initial: { opacity: 0, scale: 0.95 }, animate: { opacity: 1, scale: 1 }, exit: { opacity: 0, scale: 0.95 }, style: style, className: "p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-600 w-[260px]" },
                    React.createElement("div", { className: "mb-2 text-[10px] font-bold text-slate-400 uppercase" }, "纯色预设"),
                    React.createElement("div", { className: "grid grid-cols-6 gap-2 mb-4" }, presetColors.map(c => React.createElement("button", { key: c, onClick: () => { onChange(c); setHsv(hexToHsv(c)); }, className: "w-6 h-6 rounded-full border border-slate-200 dark:border-slate-600 hover:scale-110 transition-transform", style: { backgroundColor: c } }))),
                    React.createElement("div", { className: "mb-2 text-[10px] font-bold text-slate-400 uppercase" }, "渐变预设"),
                    React.createElement("div", { className: "grid grid-cols-3 gap-2 mb-4" }, presetGradients.map((g, i) => React.createElement("button", { key: i, onClick: () => onChange(g), className: "w-full h-6 rounded-full border border-slate-200 dark:border-slate-600 hover:scale-105 transition-transform", style: { background: g } }))),
                    React.createElement(AnimatePresence, null, showAdvanced && React.createElement(motion.div, { initial: { height: 0, opacity: 0 }, animate: { height: 'auto', opacity: 1 }, exit: { height: 0, opacity: 0 }, className: "overflow-hidden" }, React.createElement("div", { className: "mb-2 pt-2 border-t border-slate-100 dark:border-slate-700" }, React.createElement("div", { className: "mb-2 text-[10px] font-bold text-slate-400 uppercase" }, "高级调色"), React.createElement(SaturationBrightnessPicker, { hue: hsv.h, saturation: hsv.s, value: hsv.v, onChange: (s, v) => updateColorFromHsv(hsv.h, s, v) }), React.createElement(HueSlider, { hue: hsv.h, onChange: (h) => updateColorFromHsv(h, hsv.s, hsv.v) })))),
                    React.createElement("div", { className: "flex gap-2 items-center mt-2" },
                        React.createElement("input", { type: "text", value: color, onChange: (e) => { onChange(e.target.value); setHsv(hexToHsv(e.target.value)); }, className: "w-full text-xs px-2 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-900 border border-transparent focus:border-blue-500 outline-none font-mono", placeholder: "#HEX or gradient" }),
                        React.createElement("button", { onClick: () => setShowAdvanced(!showAdvanced), className: `p-1.5 rounded-lg transition-colors ${showAdvanced ? 'bg-blue-100 text-blue-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'} hover:bg-blue-100`, title: showAdvanced ? "收起色盘" : "展开色盘" }, React.createElement(Palette, { size: 14 })),
                        window.EyeDropper && React.createElement("button", { onClick: async () => { try { const eyeDropper = new EyeDropper(); const result = await eyeDropper.open(); const newHex = result.sRGBHex; onChange(newHex); setHsv(hexToHsv(newHex)); } catch (e) {} }, className: "p-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-blue-100 text-slate-500", title: "屏幕吸管" }, React.createElement(Droplet, { size: 14 }))
                    ),
                    React.createElement("div", { className: "mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center" }, React.createElement("button", { onClick: () => { onChange(''); setHsv({h:0, s:0, v:100}); }, className: "text-[10px] text-red-400 hover:underline" }, "恢复默认"), React.createElement("button", { onClick: onClose, className: "text-[10px] bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-full font-bold" }, "完成"))
                ), document.body
            );
        };
        const ColorPicker = ({ color, onChange, label }) => {
            const [isOpen, setIsOpen] = useState(false); const buttonRef = useRef(null); const [rect, setRect] = useState(null);
            const handleOpen = () => { if (buttonRef.current) { setRect(buttonRef.current.getBoundingClientRect()); } setIsOpen(true); };
            return React.createElement("div", { className: "flex flex-col items-center relative" },
                React.createElement("label", { className: "settings-label text-xs text-slate-500 mb-1 block font-bold" }, label),
                React.createElement("button", { ref: buttonRef, onClick: handleOpen, className: `color-trigger ${!color ? 'is-transparent' : ''}`, style: { background: color || 'transparent' } }, !color && React.createElement("span", { className: "default-text-overlay text-[8px] text-slate-400 font-bold absolute inset-0 flex items-center justify-center bg-white/50 backdrop-blur-[1px]" }, "默认")),
                React.createElement(AnimatePresence, null, isOpen && React.createElement(ColorPickerPopover, { color: color || '', onChange: onChange, onClose: () => setIsOpen(false), triggerRect: rect })),
                isOpen && createPortal(React.createElement("div", { className: "fixed inset-0 z-[9998] bg-transparent", onClick: () => setIsOpen(false) }), document.body)
            );
        };

        // --- Busuanzi Stats ---
        const BusuanziStats = () => {
            useEffect(() => {
                const scriptUrl = "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";
                const oldScript = document.querySelector(`script[src="${scriptUrl}"]`);
                if (oldScript) oldScript.remove();
                const script = document.createElement('script');
                script.src = scriptUrl;
                script.async = true;
                script.referrerPolicy = "no-referrer-when-downgrade";
                document.body.appendChild(script);
            }, []);
            return React.createElement("div", { className: "mt-4 flex flex-col items-center gap-2 w-full" },
                React.createElement("div", { className: "w-full h-px bg-slate-200 dark:bg-slate-700/50" }), 
                React.createElement("div", { className: "flex items-center gap-4 text-[10px] text-slate-400 dark:text-slate-500 font-bold select-none pt-2 opacity-80 hover:opacity-100 transition-opacity" },
                    React.createElement("span", { id: "busuanzi_container_site_pv", className: "flex items-center gap-1", style: { display: 'none' } },
                        React.createElement(Eye, { size: 12 }), "访问量", React.createElement("span", { id: "busuanzi_value_site_pv", className: "font-mono text-slate-600 dark:text-slate-400" })
                    ),
                    React.createElement("span", { className: "w-px h-3 bg-slate-300 dark:bg-slate-700" }),
                    React.createElement("span", { id: "busuanzi_container_site_uv", className: "flex items-center gap-1", style: { display: 'none' } },
                        React.createElement(User, { size: 12 }), "访客数", React.createElement("span", { id: "busuanzi_value_site_uv", className: "font-mono text-pink-500 dark:text-pink-400" })
                    )
                )
            );
        };

        // --- Components ---
        const GlassCard = React.forwardRef(({ children, className = "", onClick, hoverColor, glassSettings, isDragging, onPointerDown }, ref) => (
            React.createElement("div", { ref: ref, onPointerDown: onPointerDown, onClick: onClick, className: `glass-panel rounded-[2rem] transition-colors transition-shadow duration-300 ${className} ${isDragging ? 'cursor-grabbing z-[50] ring-4 ring-blue-400/50 shadow-2xl' : 'hover-glow cursor-grab active:cursor-grabbing'}`, style: { '--hover-color': hoverColor, '--glass-opacity': glassSettings?.opacity ?? 0.2, '--glass-blur': (glassSettings?.blur ?? 25) + 'px', ...(hoverColor ? { borderColor: 'transparent' } : {}) } },
                React.createElement("style", null, `.glass-card-${ref?.current?.id || 'dynamic'}:hover { border-top-color: ${hoverColor} !important; }`),
                children
            )
        ));
        
        // --- Custom Cursor ---
        const CustomCursor = ({ enableCursor, enableParticles }) => {
            const cursorX = useMotionValue(-100); const cursorY = useMotionValue(-100); 
            const springConfigPC = { damping: 20, stiffness: 400 }; 
            const pcX = useSpring(cursorX, springConfigPC); 
            const pcY = useSpring(cursorY, springConfigPC);
            
            const [isTouch, setIsTouch] = useState(false); const [isClicking, setIsClicking] = useState(false); const [particles, setParticles] = useState([]); const [isHoveringInteractive, setIsHoveringInteractive] = useState(false); const lastParticleTime = useRef(0);
            useEffect(() => {
                 let idCounter = 0;
                 const onMouseOver = (e) => { const target = e.target; const isInteractive = target.tagName === 'A' || target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT' || target.tagName === 'LABEL' || target.closest('a') || target.closest('button') || target.classList.contains('cursor-pointer') || window.getComputedStyle(target).cursor === 'pointer'; setIsHoveringInteractive(isInteractive); };
                 const onMouseMove = (e) => { setIsTouch(false); cursorX.set(e.clientX); cursorY.set(e.clientY); const now = Date.now(); if (enableParticles && now - lastParticleTime.current > 40 && Math.random() > 0.7) { lastParticleTime.current = now; const id = idCounter++; setParticles(prev => [...prev.slice(-10), { id, x: e.clientX, y: e.clientY, color: Math.random() > 0.5 ? '#64d2ff' : '#ff7eb3' }]); setTimeout(() => setParticles(prev => prev.filter(p => p.id !== id)), 600); } };
                 const onTouchMove = (e) => { setIsTouch(true); if (e.touches.length > 0) { cursorX.set(e.touches[0].clientX); cursorY.set(e.touches[0].clientY); }};
                 const onTouchStart = (e) => { setIsTouch(true); setIsClicking(true); if (e.touches.length > 0) { cursorX.set(e.touches[0].clientX); cursorY.set(e.touches[0].clientY); }};
                 const onMouseDown = () => setIsClicking(true); const onMouseUp = () => setIsClicking(false); const onTouchEnd = () => setIsClicking(false);
                 window.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseover', onMouseOver); 
                 window.addEventListener('touchmove', onTouchMove, { passive: true }); 
                 window.addEventListener('touchstart', onTouchStart, { passive: true }); 
                 window.addEventListener('mousedown', onMouseDown); window.addEventListener('mouseup', onMouseUp); window.addEventListener('touchend', onTouchEnd);
                 return () => { 
                    window.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseover', onMouseOver); 
                    window.removeEventListener('touchmove', onTouchMove); 
                    window.removeEventListener('touchstart', onTouchStart); 
                    window.removeEventListener('mousedown', onMouseDown); window.removeEventListener('mouseup', onMouseUp); window.removeEventListener('touchend', onTouchEnd); 
                 }
            }, [enableParticles]);
            
            return React.createElement(AnimatePresence, null, !isTouch && React.createElement(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, transition: { duration: 0.2 }, className: "pointer-events-none z-[9999] fixed inset-0 overflow-hidden !transition-none" }, 
                enableParticles && particles.map(p => React.createElement(motion.div, { key: p.id, initial: { opacity: 0.8, scale: 1, x: p.x, y: p.y }, animate: { opacity: 0, scale: 0, x: p.x + (Math.random() - 0.5) * 20, y: p.y + (Math.random() - 0.5) * 20 }, transition: { duration: 0.6 }, className: "fixed w-2 h-2 rounded-full pointer-events-none !transition-none", style: { backgroundColor: p.color } })),
                enableCursor && React.createElement(motion.div, { className: "fixed top-0 left-0 pointer-events-none will-change-transform !transition-none", style: { x: isTouch ? cursorX : pcX, y: isTouch ? cursorY : pcY } }, React.createElement("div", { className: "-translate-x-1/2 -translate-y-1/2" }, React.createElement(motion.div, { animate: { scale: isClicking ? 2.5 : (isHoveringInteractive ? 0 : 1), opacity: isHoveringInteractive ? 0 : 1, backgroundColor: isClicking ? "rgba(255, 255, 255, 0)" : "rgba(255, 255, 255, 0.05)", backdropFilter: isClicking ? "blur(0px)" : "blur(4px)", borderColor: isClicking ? "rgba(100, 210, 255, 0.3)" : "rgba(96, 165, 250, 0.8)" }, transition: { type: "spring", stiffness: 400, damping: 25 }, className: "w-12 h-12 rounded-full border-2 shadow-[0_0_15px_rgba(100,210,255,0.5)] flex items-center justify-center overflow-hidden !transition-none" }, React.createElement(motion.div, { animate: { opacity: isClicking ? 0 : 1 }, className: "absolute top-1 left-2 w-4 h-2 bg-white/60 rounded-full rotate-[-45deg] blur-[1px] !transition-none" }), React.createElement(motion.div, { animate: { opacity: isClicking ? 0 : 1 }, className: "w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_5px_#3b82f6] !transition-none" }))))));
        };

        const Modal = ({ isOpen, onClose, title, children, glassSettings }) => (
            React.createElement(AnimatePresence, null, isOpen && React.createElement(React.Fragment, null, 
                React.createElement(motion.div, { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 }, onClick: onClose, className: "fixed inset-0 bg-black/40 backdrop-blur-[2px] z-[60]" }), 
                React.createElement("div", { className: "fixed inset-0 z-[61] flex items-center justify-center pointer-events-none" },
                    React.createElement(motion.div, { initial: { opacity: 0, scale: 0.9, y: 20 }, animate: { opacity: 1, scale: 1, y: 0 }, exit: { opacity: 0, scale: 0.9, y: 20 }, className: "w-full max-w-md p-6 pointer-events-auto m-4 max-h-[80vh] overflow-y-auto rounded-[2.5rem] shadow-2xl glass-panel no-scrollbar", style: { '--glass-opacity': glassSettings?.opacity ?? 0.3, '--glass-blur': (glassSettings?.blur ?? 20) + 'px' } }, 
                        React.createElement("div", { className: "flex justify-between items-center mb-6" }, React.createElement("h3", { className: "ui-modal-title text-xl font-black text-slate-800 dark:text-white" }, title), React.createElement("button", { onClick: onClose, className: "p-2 rounded-full hover:bg-white/40 dark:hover:bg-slate-700/40 transition-colors" }, React.createElement(X, { className: "w-5 h-5" }))), 
                        children
                    )
                )
            ))
        );
        const SectionHeader = ({ icon: Icon, title }) => (
            React.createElement("div", { className: "flex items-center gap-2 mb-3 mt-1" }, React.createElement(Icon, { size: 18, className: "text-blue-500" }), React.createElement("label", { className: "block text-base font-bold text-slate-700 dark:text-slate-300 section-title" }, title))
        );

        const App = () => {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
            const [bodyFont, setBodyFont] = useState(() => localStorage.getItem('body_font') || '"Nunito", "M PLUS Rounded 1c", sans-serif');
            const [bgImage, setBgImage] = useState(() => localStorage.getItem('bg_image') || DEFAULT_BG);
            const [searchEngine, setSearchEngine] = useState(() => {
                const storedEngineId = localStorage.getItem('default_search_engine');
                if (storedEngineId) { const engine = SEARCH_ENGINES.find(e => e.id === storedEngineId); if (engine) return engine; }
                return SEARCH_ENGINES[0];
            });
            const [searchQuery, setSearchQuery] = useState('');
            
            // --- Undo/Redo Stacks ---
            const [undoStack, setUndoStack] = useState([]);
            const [redoStack, setRedoStack] = useState([]);

            // Helper to update search with history tracking
            const updateSearchWithHistory = (newValue) => {
                if (newValue !== searchQuery) {
                    setUndoStack(prev => [...prev, searchQuery]);
                    setRedoStack([]); // Clear redo stack on new input
                    setSearchQuery(newValue);
                }
            };

            const [links, setLinks] = useState(() => {
                const storedLinks = localStorage.getItem('my_links');
                return storedLinks ? JSON.parse(storedLinks) : DEFAULT_LINKS;
            });
            const [history, setHistory] = useState(() => {
                const storedHistory = localStorage.getItem('search_history_v2');
                return storedHistory ? JSON.parse(storedHistory) : [];
            });
            const defaultLightColors = { searchBtn: '#3b82f6', blobLeft: '#60a5fa', blobRight: '#f472b6', title1: '', title2: '', particle: '', textColor: '', subTextColor: '#64748b', modalTitleColor: '', sectionTitleColor: '', labelColor: '', cardHover: '#f472b6' };
            const defaultDarkColors = { searchBtn: '#6366f1', blobLeft: '#8b5cf6', blobRight: '#ec4899', title1: '', title2: '', particle: '', textColor: '#e2e8f0', subTextColor: '#94a3b8', modalTitleColor: '', sectionTitleColor: '', labelColor: '', cardHover: '#ec4899' };
            const [colors, setColors] = useState(() => {
                const key = theme === 'dark' ? 'custom_colors_dark' : 'custom_colors_light';
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : (theme === 'dark' ? defaultDarkColors : defaultLightColors);
            });
            useEffect(() => { document.documentElement.classList.toggle('dark', theme === 'dark'); const key = theme === 'dark' ? 'custom_colors_dark' : 'custom_colors_light'; const stored = localStorage.getItem(key); setColors(stored ? JSON.parse(stored) : (theme === 'dark' ? defaultDarkColors : defaultLightColors)); }, [theme]);
            const updateColor = (key, value) => { const newColors = { ...colors, [key]: value }; setColors(newColors); const storageKey = theme === 'dark' ? 'custom_colors_dark' : 'custom_colors_light'; localStorage.setItem(storageKey, JSON.stringify(newColors)); };
            const updateBodyFont = (font) => { setBodyFont(font); localStorage.setItem('body_font', font); };
            const [glassSettings, setGlassSettings] = useState(() => { const storedGlass = localStorage.getItem('glass_settings'); return storedGlass ? JSON.parse(storedGlass) : { opacity: 0.2, blur: 25 }; });
            
            const [layoutSettings, setLayoutSettings] = useState(() => { 
                const storedLayout = localStorage.getItem('layout_settings'); 
                const parsed = storedLayout ? JSON.parse(storedLayout) : {};
                return { ...DEFAULT_LAYOUT, ...parsed, gridTop_top: parsed.gridTop_top ?? 0, gridTop_center: parsed.gridTop_center ?? 0 }; 
            });
            const [showSettings, setShowSettings] = useState(false); const [showLinkModal, setShowLinkModal] = useState(false); const [editingLink, setEditingLink] = useState(null); const [linkForm, setLinkForm] = useState({ title: '', url: '', desc: '', iconUrl: '' });
            const [visualSettings, setVisualSettings] = useState(() => { const stored = localStorage.getItem('visual_settings'); return stored ? { ...DEFAULT_VISUALS, ...JSON.parse(stored) } : DEFAULT_VISUALS; });
            const updateVisuals = (key, value) => { const newSettings = { ...visualSettings, [key]: value }; setVisualSettings(newSettings); localStorage.setItem('visual_settings', JSON.stringify(newSettings)); };
            const [avatarUrl, setAvatarUrl] = useState(() => localStorage.getItem('avatar_url') || DEFAULT_AVATAR);
            const [faviconUrl, setFaviconUrl] = useState(() => localStorage.getItem('favicon_url') || DEFAULT_AVATAR);
            const updateAvatar = (url) => { setAvatarUrl(url); localStorage.setItem('avatar_url', url); };
            const updateFavicon = (url) => { setFaviconUrl(url); localStorage.setItem('favicon_url', url); };
            const [isEngineMenuOpen, setIsEngineMenuOpen] = useState(false);
            const engineMenuRef = useRef(null);
            const [showHistory, setShowHistory] = useState(false); const [draggingId, setDraggingId] = useState(null); const [isSearchFocused, setIsSearchFocused] = useState(false);
            const dragStartPos = useRef({ x: 0, y: 0 }); const lastSwapTime = useRef(0); const constraintsRef = useRef(null); const fileInputRef = useRef(null); const bgFileInputRef = useRef(null); const searchInputRef = useRef(null); 
            const avatarInputRef = useRef(null); const faviconInputRef = useRef(null);
            const isAutoFocusing = useRef(false);
            const [isBgLoaded, setIsBgLoaded] = useState(() => { const saved = localStorage.getItem('bg_image'); return !saved; });

            // --- Context Menu State & Handlers ---
            const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, hasSelection: false });

            const handleContextMenu = useCallback((e) => {
                e.preventDefault();
                const hasSelection = window.getSelection().toString().length > 0;
                setContextMenu({
                    visible: true,
                    x: e.clientX,
                    y: e.clientY,
                    hasSelection: hasSelection
                });
            }, []);

            const closeContextMenu = useCallback(() => {
                setContextMenu(prev => ({ ...prev, visible: false }));
            }, []);

            const handleContextPaste = async () => {
                closeContextMenu();
                searchInputRef.current?.focus();
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        // Insert at cursor position would be ideal, but for simplicity append or replace
                        updateSearchWithHistory(searchQuery + text);
                    }
                } catch (err) {
                    console.error("Clipboard permission denied or error:", err);
                    alert("请在弹出的提示中允许访问剪贴板，以便使用右键粘贴功能。");
                }
            };

            const handleContextPasteAndSearch = async () => {
                closeContextMenu();
                searchInputRef.current?.focus();
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        updateSearchWithHistory(text); // Usually Paste & Go replaces content
                        executeSearch(text);
                    }
                } catch (err) {
                    console.error("Clipboard permission denied or error:", err);
                }
            };

            const handleContextCopy = () => {
                closeContextMenu();
                const selection = window.getSelection().toString();
                if (selection) {
                    navigator.clipboard.writeText(selection).catch(err => console.error("Copy failed", err));
                }
            };

            const handleContextCut = () => {
                closeContextMenu();
                const selection = window.getSelection().toString();
                if (selection) {
                    navigator.clipboard.writeText(selection).then(() => {
                        // Crude implementation: remove selection from query
                        // This removes ALL occurrences if simple replace, or relies on exact string match
                        // For a controlled input, getting exact cursor indices is better but complex here.
                        // Simplified: clear input if full select, or try to replace.
                        if (selection === searchQuery) {
                            updateSearchWithHistory('');
                        } else {
                            // Basic string replacement
                            updateSearchWithHistory(searchQuery.replace(selection, '')); 
                        }
                    });
                }
            };

            const handleContextDelete = () => {
                closeContextMenu();
                const selection = window.getSelection().toString();
                if (selection) {
                     if (selection === searchQuery) {
                        updateSearchWithHistory('');
                    } else {
                        updateSearchWithHistory(searchQuery.replace(selection, '')); 
                    }
                }
            };

            const handleSelectAll = () => {
                closeContextMenu();
                searchInputRef.current?.select();
            }

            const handleContextUndo = () => {
                // closeContextMenu(); // Keep menu open for rapid undo? Maybe close is better.
                if (undoStack.length > 0) {
                    const prev = undoStack[undoStack.length - 1];
                    const newUndo = undoStack.slice(0, -1);
                    setRedoStack(curr => [...curr, searchQuery]);
                    setUndoStack(newUndo);
                    setSearchQuery(prev);
                }
            };

            const handleContextRedo = () => {
                // closeContextMenu();
                if (redoStack.length > 0) {
                    const next = redoStack[redoStack.length - 1];
                    const newRedo = redoStack.slice(0, -1);
                    setUndoStack(curr => [...curr, searchQuery]);
                    setRedoStack(newRedo);
                    setSearchQuery(next);
                }
            };
            
            useEffect(() => { if (!bgImage) { setIsBgLoaded(true); return; } setIsBgLoaded(false); const img = new Image(); img.src = bgImage; const handleLoad = () => { setIsBgLoaded(true); }; img.onload = handleLoad; img.onerror = handleLoad; const timer = setTimeout(handleLoad, 3000); return () => { clearTimeout(timer); img.onload = null; img.onerror = null; }; }, [bgImage]);
            useEffect(() => { if (isBgLoaded) { const timer = setTimeout(() => { document.body.classList.add('blur-loaded'); }, 1800); return () => clearTimeout(timer); } else { document.body.classList.remove('blur-loaded'); } }, [isBgLoaded]);
            
            useEffect(() => {
                const tryFocus = () => {
                    if (searchInputRef.current) {
                        isAutoFocusing.current = true;
                        searchInputRef.current.focus();
                        setTimeout(() => { isAutoFocusing.current = false; }, 200);
                    }
                };
                
                tryFocus();
                const timer1 = setTimeout(tryFocus, 100);
                const timer2 = setTimeout(tryFocus, 500); 
                
                return () => {
                    clearTimeout(timer1);
                    clearTimeout(timer2);
                };
            }, [layoutSettings.searchPos]);

            useEffect(() => { const setCircularFavicon = (url) => { const link = document.getElementById('dynamic-favicon') || document.createElement('link'); link.id = 'dynamic-favicon'; link.type = 'image/png'; link.rel = 'icon'; link.href = url; if (!link.parentNode) document.head.appendChild(link); }; setCircularFavicon(faviconUrl); }, [faviconUrl]);
            
            const getTextStyle = (color) => { if (!color) return {}; if (color.includes('gradient')) { return { backgroundImage: color, WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', backgroundClip: 'text', color: 'transparent', textShadow: 'none' }; } return { color: color, textShadow: '0 2px 10px rgba(0,0,0,0.2)' }; };
            const { suggestions, topPrediction } = useMemo(() => {
                const q = searchQuery.trim().toLowerCase();
                let combined = [];
                const historyCandidates = history.map(h => ({ type: 'history', value: h.query, count: h.count, score: h.count * 1 })); 
                const linkCandidates = links.map(l => ({ type: 'link', value: l.url, title: l.title, url: l.url, count: l.visitCount || 0, score: (l.visitCount || 0) * 5 })); 
                if (!q) { combined = historyCandidates.sort((a, b) => b.lastUsed - a.lastUsed).slice(0, 15); } else { const historyMatches = historyCandidates.filter(h => h.value.toLowerCase().startsWith(q)); const linkMatches = linkCandidates.filter(l => { const cleanUrl = l.url.replace(/^https?:\/\//, '').toLowerCase(); return l.title.toLowerCase().includes(q) || cleanUrl.includes(q); }); combined = [...historyMatches, ...linkMatches].sort((a, b) => b.score - a.score).slice(0, 30); }
                let prediction = '';
                if (q) { const predictionCandidates = [...historyCandidates, ...linkCandidates].filter(item => { const val = item.type === 'link' ? item.title : item.value; return val.toLowerCase().startsWith(q); }).sort((a, b) => b.score - a.score); if (predictionCandidates.length > 0) { const bestMatch = predictionCandidates[0]; const matchText = bestMatch.type === 'link' ? bestMatch.title : bestMatch.value; prediction = searchQuery + matchText.slice(searchQuery.length); } }
                return { suggestions: combined, topPrediction: prediction };
            }, [searchQuery, history, links]);

            const saveLinks = (newLinks) => { setLinks(newLinks); localStorage.setItem('my_links', JSON.stringify(newLinks)); };
            const updateLayout = (key, value) => { const newLayout = { ...layoutSettings, [key]: value }; setLayoutSettings(newLayout); localStorage.setItem('layout_settings', JSON.stringify(newLayout)); };
            
            useEffect(() => { const handleClickOutside = (event) => { if (engineMenuRef.current && !engineMenuRef.current.contains(event.target)) { setIsEngineMenuOpen(false); } }; if (isEngineMenuOpen) { document.addEventListener('mousedown', handleClickOutside); } return () => { document.removeEventListener('mousedown', handleClickOutside); }; }, [isEngineMenuOpen]);
            
            const handleDrag = (e, info, id) => { if (Date.now() - lastSwapTime.current < 400) return; let clientX, clientY; if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; } if (clientX === undefined) { clientX = info.point.x; clientY = info.point.y; } const elements = document.elementsFromPoint(clientX, clientY); let targetId = null; for (const el of elements) { const sortableEl = el.closest('[data-sortable-id]'); if (sortableEl) { const foundId = sortableEl.getAttribute('data-sortable-id'); if (foundId && foundId !== id) { targetId = foundId; break; } } } if (targetId) { if (targetId === 'add-btn') { const fromIndex = links.findIndex(l => l.id === id); if (fromIndex === links.length - 1) return; const newLinks = [...links]; const [item] = newLinks.splice(fromIndex, 1); newLinks.push(item); saveLinks(newLinks); lastSwapTime.current = Date.now(); return; } const fromIndex = links.findIndex(l => l.id === id); const toIndex = links.findIndex(l => l.id === targetId); if (fromIndex !== -1 && toIndex !== -1 && fromIndex !== toIndex) { const newLinks = [...links]; const [item] = newLinks.splice(fromIndex, 1); newLinks.splice(toIndex, 0, item); saveLinks(newLinks); lastSwapTime.current = Date.now(); } } };
            const handleLinkClick = (link) => { const newLinks = links.map(l => { if (l.id === link.id) { return { ...l, visitCount: (l.visitCount || 0) + 1 }; } return l; }); saveLinks(newLinks); window.open(link.url, '_blank'); setShowHistory(false); };
            const executeSearch = (query, forceEngine = false) => { if (!query.trim()) return; if (!forceEngine) { const qLower = query.trim().toLowerCase(); const linkMatch = links.find(l => l.title.toLowerCase() === qLower); const historyMatch = history.find(h => h.query.toLowerCase() === qLower); const linkScore = linkMatch ? (linkMatch.visitCount || 0) * 5 : -1; const historyScore = historyMatch ? historyMatch.count : -1; if (linkMatch && linkScore >= historyScore) { handleLinkClick(linkMatch); return; } } const newHistory = [...history]; const existingIndex = newHistory.findIndex(h => h.query === query); if (existingIndex > -1) { newHistory[existingIndex].count += 1; newHistory[existingIndex].lastUsed = Date.now(); } else { newHistory.push({ query: query, count: 1, lastUsed: Date.now() }); } newHistory.sort((a, b) => b.count - a.count || b.lastUsed - a.lastUsed); const trimmedHistory = newHistory.slice(0, 50); setHistory(trimmedHistory); localStorage.setItem('search_history_v2', JSON.stringify(trimmedHistory)); const isUrl = (str) => { if (/^https?:\/\//i.test(str)) return true; if (/^localhost:\d+$/i.test(str)) return true; if (/^(\d{1,3}\.){3}\d{1,3}(:\d+)?$/.test(str)) return true; if (/^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(:\d+)?(\/.*)?$/.test(str)) return true; return false; }; if (isUrl(query) && !forceEngine) { let finalUrl = query; if (!/^https?:\/\//i.test(query)) { finalUrl = 'http://' + query; } window.open(finalUrl, '_blank'); } else { window.open(searchEngine.url + encodeURIComponent(query), '_blank'); } setShowHistory(false); searchInputRef.current?.blur(); };
            const handleSearch = (e) => { e.preventDefault(); if (topPrediction && topPrediction.length > searchQuery.length) { executeSearch(topPrediction); } else { executeSearch(searchQuery); } };
            
            const handleSuggestionClick = (item) => { if (item.type === 'link') { handleLinkClick(item); } else { setSearchQuery(item.value); executeSearch(item.value, true); } setShowHistory(false); };
            const deleteHistoryItem = (itemQuery, e) => { e.stopPropagation(); const newHistory = history.filter(h => h.query !== itemQuery); setHistory(newHistory); localStorage.setItem('search_history_v2', JSON.stringify(newHistory)); };
            const clearHistory = () => { setHistory([]); localStorage.removeItem('search_history_v2'); };
            const openLinkModal = (link = null) => { if (link) { setEditingLink(link); setLinkForm({ title: link.title, url: link.url, desc: link.desc || '', iconUrl: link.iconUrl || '' }); } else { setEditingLink(null); setLinkForm({ title: '', url: '', desc: '', iconUrl: '' }); } setShowLinkModal(true); };
            const saveLink = () => { if (!linkForm.title || !linkForm.url) return; let updatedLinks; if (editingLink) { updatedLinks = links.map(l => l.id === editingLink.id ? { ...l, ...linkForm, url: linkForm.url.startsWith('http') ? linkForm.url : `https://${linkForm.url}` } : l); } else { const newLinkItem = { id: Date.now().toString(), title: linkForm.title, url: linkForm.url.startsWith('http') ? linkForm.url : `https://${linkForm.url}`, desc: linkForm.desc || '自定义链接', iconUrl: linkForm.iconUrl, visitCount: 0 }; updatedLinks = [...links, newLinkItem]; } saveLinks(updatedLinks); setShowLinkModal(false); };
            const deleteLink = (id, e) => { e.stopPropagation(); const updatedLinks = links.filter(l => l.id !== id); saveLinks(updatedLinks); };
            const updateBg = (url) => { setBgImage(url); localStorage.setItem('bg_image', url); };
            const updateGlass = (key, value) => { const newSettings = { ...glassSettings, [key]: parseFloat(value) }; setGlassSettings(newSettings); localStorage.setItem('glass_settings', JSON.stringify(newSettings)); };
            const resetSettings = () => { if(confirm("确定要重置所有设置吗？")) { localStorage.clear(); location.reload(); } }
            const setDefaultEngine = (engine) => { setSearchEngine(engine); localStorage.setItem('default_search_engine', engine.id); };
            const toggleTheme = (e) => { const newTheme = theme === 'dark' ? 'light' : 'dark'; setTheme(newTheme); localStorage.setItem('theme', newTheme); if (!document.startViewTransition) { return; } const x = e.clientX, y = e.clientY; const endRadius = Math.hypot(Math.max(x, window.innerWidth - x), Math.max(y, window.innerHeight - y)); const transition = document.startViewTransition(() => {}); transition.ready.then(() => { document.documentElement.animate({ clipPath: [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`] }, { duration: 500, easing: "ease-in-out", pseudoElement: "::view-transition-new(root)" }); }); };
            const getFavicon = (link) => { if (link.iconUrl) return link.iconUrl; try { const domain = new URL(link.url).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`; } catch { return 'https://www.google.com/s2/favicons?domain=google.com'; } };
            const handleFileUpload = (e, callback) => { const file = e.target.files[0]; if (!file) return; if (file.size > 3 * 1024 * 1024) { alert("图片有点大哦 (>3MB)！浏览器存不下啦，请压缩后再试。"); return; } const reader = new FileReader(); reader.onloadend = () => { callback(reader.result); }; reader.readAsDataURL(file); };
            const sortedEngines = useMemo(() => { const selected = SEARCH_ENGINES.find(e => e.id === searchEngine.id) || SEARCH_ENGINES[0]; const others = SEARCH_ENGINES.filter(e => e.id !== searchEngine.id); return [selected, ...others]; }, [searchEngine]);

            useEffect(() => {
                document.body.style.fontFamily = bodyFont;
                if (colors.textColor) { document.body.style.color = colors.textColor; } else { document.body.style.color = ''; }
                const styleId = 'custom-colors-style'; let styleTag = document.getElementById(styleId); if (!styleTag) { styleTag = document.createElement('style'); styleTag.id = styleId; document.head.appendChild(styleTag); }
                let cssRules = '';
                if (colors.subTextColor) { cssRules += ` .text-slate-500, .dark .text-slate-300, .text-slate-400, .dark .text-slate-400 { color: ${colors.subTextColor} !important; } `; }
                if (colors.modalTitleColor) { cssRules += ` .ui-modal-title { color: ${colors.modalTitleColor} !important; } `; }
                if (colors.sectionTitleColor) { cssRules += ` .section-title { color: ${colors.sectionTitleColor} !important; } `; }
                if (colors.labelColor) { cssRules += ` .settings-label { color: ${colors.labelColor} !important; } `; }
                styleTag.innerHTML = cssRules;
            }, [bodyFont, colors]);

            const engineCount = SEARCH_ENGINES.length;
            const btnWidth = 44;
            const gap = 24;
            const paddingOpen = 6; 
            const expandedWidth = (btnWidth + gap) * (engineCount - 1) + btnWidth + paddingOpen * 2;

            const getBlobClass = (type) => {
                return `absolute rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-${type}`;
            };

            const isCenterMode = layoutSettings.searchPos === 'center' || !layoutSettings.showCollections;
            const currentGridTop = isCenterMode ? (layoutSettings.gridTop_center || 0) : (layoutSettings.gridTop_top || 0);
            
            const GAP_THRESHOLD = 260; 
            const shouldFloat = currentGridTop > GAP_THRESHOLD;
            const isHistoryOpen = showHistory && suggestions.length > 0;
            const dynamicGridTop = (isHistoryOpen && !shouldFloat) ? Math.min(currentGridTop, 24) : currentGridTop;

            return React.createElement("div", { className: "min-h-screen relative flex flex-col overflow-x-hidden", onContextMenu: (e) => {
                // Optional: Global Context Menu? Or just on search bar?
                // Let's keep it global for consistency if desired, but for now specific to search area is safer.
                // e.preventDefault(); 
            }},
                React.createElement(CustomCursor, { enableCursor: visualSettings.enableCursor, enableParticles: visualSettings.enableParticles }), 
                React.createElement(CustomContextMenu, { 
                    visible: contextMenu.visible, 
                    x: contextMenu.x, 
                    y: contextMenu.y, 
                    onClose: closeContextMenu,
                    onPaste: handleContextPaste,
                    onPasteAndSearch: handleContextPasteAndSearch,
                    onCopy: handleContextCopy,
                    onCut: handleContextCut,
                    onDelete: handleContextDelete,
                    hasSelection: contextMenu.hasSelection,
                    onSelectAll: handleSelectAll,
                    onUndo: handleContextUndo,
                    onRedo: handleContextRedo,
                    canUndo: undoStack.length > 0,
                    canRedo: redoStack.length > 0,
                    glassSettings: glassSettings
                }),

                // 背景层
                React.createElement("div", { className: "fixed inset-0 z-0", style: { transform: 'translateZ(0)' } }, 
                    bgImage && React.createElement(motion.div, { key: bgImage, initial: { opacity: 0 }, animate: { opacity: 1 }, transition: { duration: 1 }, className: "absolute inset-0 bg-cover bg-center bg-no-repeat", style: { backgroundImage: `url(${bgImage})` } }),
                    React.createElement("div", { className: `absolute inset-0 backdrop-blur-[1px] transition-colors duration-500 ${ bgImage ? 'bg-black/20 dark:bg-black/70' : 'bg-white/10 dark:bg-slate-950/30' }` }),
                    visualSettings.enableDynamicBlobs && React.createElement(React.Fragment, null,
                        React.createElement("div", { className: `top-[-10%] left-[-10%] w-[60%] h-[60%] ${getBlobClass('blob-left')}`, style: { backgroundColor: colors.blobLeft, opacity: bgImage ? 0.5 : 0.3 } }),
                        React.createElement("div", { className: `bottom-[-10%] right-[-10%] w-[60%] h-[60%] ${getBlobClass('blob-right')}`, style: { backgroundColor: colors.blobRight, opacity: bgImage ? 0.5 : 0.3 } })
                    )
                ),
                // 顶部胶囊栏
                React.createElement(motion.div, { className: "fixed top-4 left-4 z-[100] flex items-center gap-3 p-2 pr-3 rounded-full shadow-lg glass-panel", style: { '--glass-opacity': glassSettings.opacity, '--glass-blur': glassSettings.blur + 'px' }, variants: ITEM_VARIANTS, initial: "hidden", animate: "visible" },
                    React.createElement("div", { onClick: () => setShowSettings(true), className: "relative group cursor-pointer" }, React.createElement("div", { className: "w-10 h-10 rounded-full overflow-hidden border-2 border-white/60 dark:border-slate-500/60 shadow-sm" }, React.createElement("img", { src: avatarUrl, alt: "Avatar", className: "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" }))),
                    React.createElement("div", { className: "w-px h-6 bg-white/50 dark:bg-white/20 mx-1" }),
                    React.createElement("div", { className: "flex items-center gap-2" }, React.createElement("button", { onClick: toggleTheme, className: "p-2 rounded-full text-slate-700 dark:text-slate-200 hover:bg-white/30 dark:hover:bg-slate-700/50 hover:text-blue-500 dark:hover:text-blue-400 transition-all" }, theme === 'light' ? React.createElement(Moon, { size: 18 }) : React.createElement(Sun, { size: 18 })), React.createElement("button", { onClick: () => setShowSettings(true), className: "p-2 rounded-full text-slate-700 dark:text-slate-200 hover:bg-white/30 dark:hover:bg-slate-700/50 hover:text-blue-500 dark:hover:text-blue-400 transition-all" }, React.createElement(Settings, { size: 18 })))
                ),
                // 主要内容区
                React.createElement(motion.main, { variants: CONTAINER_VARIANTS, initial: "hidden", animate: isBgLoaded ? "visible" : "hidden", className: `relative z-10 w-full max-w-[95%] xl:max-w-[1800px] mx-auto px-4 md:px-6 min-h-screen flex flex-col` },
                    // 核心内容包裹器
                    React.createElement("div", { className: `flex-1 w-full flex flex-col items-center py-20 transition-all duration-500 ${ isCenterMode ? 'justify-start pt-[35vh]' : 'justify-start pt-32 md:pt-24' }` },
                        // 标题
                        layoutSettings.showTitle && React.createElement(motion.div, { variants: ITEM_VARIANTS, className: "text-center mb-12 select-none" },
                            React.createElement(motion.div, { key: theme, className: "flex flex-wrap justify-center items-center gap-1 md:gap-3 cursor-default", onDragStart: (e) => e.preventDefault() },
                                React.createElement(motion.span, { className: `text-5xl md:text-7xl font-black tracking-tight inline-block font-sans ${ colors.title1 ? '' : (bgImage ? 'text-white shadow-text-super' : 'text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-cyan-400 shadow-text-gradient') }`, style: getTextStyle(colors.title1), whileHover: { scale: 1.05, rotate: -2 }, whileTap: { scale: 0.95, rotate: 3 }, transition: { type: "spring", stiffness: 300 } }, layoutSettings.text1 || 'AKISATO'),
                                React.createElement(motion.span, { className: `text-4xl md:text-6xl font-black ${colors.particle ? '' : (bgImage ? 'text-white shadow-text-super' : 'text-[#1E293B] dark:text-[#e6eaee] shadow-text-solid')} inline-block mx-2 font-sans`, style: getTextStyle(colors.particle), whileHover: { y: -5, rotate: 15 }, whileTap: { scale: 1.2, rotate: -20, color: "#64d2ff" }, transition: { type: "spring", stiffness: 300 } }, layoutSettings.particleText || 'の'),
                                React.createElement(motion.span, { className: `text-5xl md:text-7xl font-black tracking-tight inline-block font-sans ${ colors.title2 ? '' : (bgImage ? 'text-white shadow-text-super' : 'text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-rose-400 shadow-text-gradient') }`, style: getTextStyle(colors.title2), whileHover: { scale: 1.05, rotate: 2 }, whileTap: { scale: 0.95, rotate: -3 }, transition: { type: "spring", stiffness: 300 } }, layoutSettings.text2 || '灯塔')
                            )
                        ),
                        // 搜索栏 (Attached Context Menu Trigger Here)
                        React.createElement(motion.div, { variants: ITEM_VARIANTS, className: "w-full max-w-2xl relative mb-8 z-50 flex flex-col items-center", onContextMenu: handleContextMenu },
                            React.createElement(motion.div, { className: "relative w-full", whileHover: { scale: 1.01 }, transition: { type: "spring", stiffness: 400, damping: 25 } },
                                React.createElement("div", { className: "absolute top-0 left-0 right-0 h-[64px] bg-gradient-to-r from-blue-400 to-pink-400 rounded-[2rem] blur-2xl opacity-20 hover:opacity-40 transition-opacity duration-500 pointer-events-none" }),
                                React.createElement("form", { onSubmit: handleSearch, className: "relative flex items-center glass-panel rounded-[2rem] p-2 z-50 transition-all duration-300 hover:shadow-search-hover border border-white/20 dark:border-white/5", style: { '--glass-opacity': glassSettings.opacity, '--glass-blur': glassSettings.blur + 'px', height: '64px' } },
                                    // 搜索引擎选择器逻辑
                                    React.createElement(motion.div, { 
                                        ref: engineMenuRef, 
                                        className: "flex items-center overflow-hidden rounded-full bg-white/10 dark:bg-black/10 backdrop-blur-sm cursor-pointer", 
                                        animate: { 
                                            width: isEngineMenuOpen ? expandedWidth : 48, 
                                            paddingRight: isEngineMenuOpen ? 6 : 2, 
                                            paddingLeft: isEngineMenuOpen ? 6 : 2   
                                        }, 
                                        transition: { type: "tween", ease: [0.22, 1, 0.36, 1], duration: 0.4 }, 
                                        style: { border: '1px solid rgba(255,255,255,0.1)', marginRight: '8px', flexShrink: 0, height: '48px' } 
                                    }, sortedEngines.map((eng, index) => React.createElement("div", { 
                                        key: eng.name, 
                                        onClick: (e) => { 
                                            e.stopPropagation(); 
                                            if (!isEngineMenuOpen) {
                                                setIsEngineMenuOpen(true);
                                            } else {
                                                setSearchEngine(eng); 
                                                setIsEngineMenuOpen(false); 
                                            }
                                        }, 
                                        className: `engine-icon-btn relative mr-6 last:mr-0 ${searchEngine.id === eng.id ? 'engine-selected' : 'engine-unselected'}`, 
                                        title: eng.name 
                                    }, React.createElement(eng.logo), eng.name === 'Google AI' && React.createElement(Sparkles, { size: 10, className: "absolute top-2 right-2 text-pink-400 pointer-events-none" })))),
                                    
                                    React.createElement("div", { className: "w-px h-8 bg-slate-400/30 dark:bg-white/20 mx-1 flex-shrink-0" }),
                                    React.createElement("div", { className: "relative flex-1 h-full" },
                                        topPrediction && topPrediction.length > searchQuery.length && searchQuery.length > 0 && React.createElement("div", { className: "absolute top-0 left-0 h-full w-full px-4 flex items-center text-lg font-bold pointer-events-none", style: { color: 'rgba(150,150,150,0.5)' } }, React.createElement("span", { className: "opacity-0" }, searchQuery), React.createElement("span", null, topPrediction.slice(searchQuery.length))),
                                        React.createElement("input", { 
                                            type: "text", 
                                            ref: searchInputRef, 
                                            value: searchQuery, 
                                            onChange: (e) => updateSearchWithHistory(e.target.value), 
                                            onFocus: () => { setIsSearchFocused(true); if (!isAutoFocusing.current) setShowHistory(true); }, 
                                            onClick: () => setShowHistory(true),
                                            onBlur: () => { setIsSearchFocused(false); setTimeout(() => setShowHistory(false), 200); }, 
                                            placeholder: `在 ${searchEngine.name} 上搜索...`, 
                                            className: `w-full h-full bg-transparent border-none outline-none ${bgImage ? 'text-white placeholder-white/80 font-bold shadow-text-strong' : 'text-slate-800 dark:text-white placeholder-slate-500/70 dark:placeholder-slate-400/70'} px-4 text-lg font-bold z-10 relative` 
                                        })
                                    ),
                                    React.createElement("button", { type: "submit", className: "p-3 w-12 h-12 rounded-full flex items-center justify-center text-white transition-transform active:scale-95 shadow-lg m-1 backdrop-blur-sm flex-shrink-0", style: { backgroundColor: colors.searchBtn, boxShadow: `0 4px 15px ${colors.searchBtn}60` } }, React.createElement(Search, { size: 24 }))
                                )
                            ),
                            // 搜索记录框：联动/悬浮逻辑 (使用最新逻辑)
                            React.createElement(AnimatePresence, null, (showHistory && suggestions.length > 0) && React.createElement(motion.div, { initial: { opacity: 0, scale: 0.98, y: -5, height: 0 }, animate: { opacity: 1, scale: 1, y: 0, height: "auto" }, exit: { opacity: 0, scale: 0.98, y: -5, height: 0 }, 
                                // 核心修复：根据 shouldFloat 决定是 absolute (悬浮) 还是 w-full (联动推挤)
                                className: `${shouldFloat ? "absolute top-full left-0 right-0 shadow-xl" : "w-full"} overflow-hidden rounded-[1.5rem] glass-panel z-40 origin-top mt-2 border border-white/20 no-scrollbar`, 
                                style: { '--glass-opacity': glassSettings.opacity + 0.1, '--glass-blur': glassSettings.blur + 'px', maxHeight: '300px', overflowY: 'auto' } },
                                React.createElement("div", { className: "p-3" }, React.createElement("div", { className: "flex flex-col gap-1" }, suggestions.map((item, idx) => React.createElement("div", { key: idx, onMouseDown: (e) => e.preventDefault(), onClick: () => item.type === 'history' ? deleteHistoryItem(item.value, {stopPropagation:()=>{}}) : null, className: `group flex items-center justify-between px-4 py-3 hover:bg-white/40 dark:hover:bg-white/10 rounded-2xl cursor-pointer transition-colors ${bgImage ? 'text-white' : 'text-slate-700 dark:text-slate-200'} font-bold` },
                                    React.createElement("span", { className: "flex items-center gap-3 truncate flex-1", onClick: (e) => { e.stopPropagation(); handleSuggestionClick(item); } }, item.type === 'link' ? React.createElement(LinkIcon, { size: 14, className: "text-pink-400" }) : React.createElement(Search, { size: 14, className: "opacity-50" }), item.type === 'link' ? item.title : item.value, item.type === 'link' && React.createElement("span", { className: "text-[10px] opacity-50 ml-2 font-normal" }, item.url), item.type === 'history' && item.count > 1 && React.createElement("span", { className: "text-[9px] bg-blue-100/50 dark:bg-blue-900/50 px-1.5 rounded ml-2 opacity-60" }, `热度 ${item.count}`), item.type === 'link' && item.count > 0 && React.createElement("span", { className: "text-[9px] bg-pink-100/50 dark:bg-pink-900/50 text-pink-600 dark:text-pink-300 px-1.5 rounded ml-2 opacity-60" }, `热度 ${item.count}`)),
                                    item.type === 'history' && React.createElement("button", { onMouseDown: (e) => e.preventDefault(), onClick: (e) => deleteHistoryItem(item.value, e), className: "p-1.5 rounded-full hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100 scale-90 group-hover:scale-100" }, React.createElement(X, { size: 14 }))
                                ))))
                            ))
                        ),
                        // 3. 网站网格 - 控制显示
                        // 核心修复：使用 animate 动态过渡 marginTop，消除空白
                        layoutSettings.showCollections && React.createElement(motion.div, { 
                            variants: ITEM_VARIANTS, 
                            className: "w-full z-10", 
                            animate: { marginTop: dynamicGridTop },
                            transition: { type: "spring", stiffness: 300, damping: 30 }
                        },
                            React.createElement("div", { className: "flex items-center gap-2 mb-6 px-4" }, 
                                React.createElement(LayoutGrid, { className: "w-6 h-6 drop-shadow", style: { color: colors.cardHover } }), 
                                React.createElement("h2", { className: `text-xl font-bold ${bgImage ? 'text-white shadow-text-super' : 'text-slate-800 dark:text-white'} drop-shadow-sm` }, "我的收藏"), 
                                React.createElement("span", { className: "text-xs font-bold px-2 py-0.5 rounded-lg backdrop-blur-sm transition-colors", style: { color: colors.cardHover, backgroundColor: colors.cardHover + '20' } }, links.length), 
                            ),
                            React.createElement(motion.div, { ref: constraintsRef, variants: { visible: { transition: { staggerChildren: 0.05 } } }, className: `flex flex-wrap justify-center gap-${layoutSettings.cardGap || 5} list-none p-0 m-0 relative w-full` },
                                [...links, { id: 'add-btn', isAddBtn: true }].map((item) => {
                                    const baseWidth = 12.5 * (layoutSettings.cardSize / 100);
                                    return React.createElement(motion.div, { key: item.id, layoutId: item.id, layout: true, transition: { duration: 0.3, ease: "easeInOut" }, "data-sortable-id": item.id, drag: true, dragConstraints: constraintsRef, dragSnapToOrigin: true, dragElastic: 0.12, dragMomentum: false, variants: ITEM_VARIANTS, onDragStart: () => { setDraggingId(item.id); dragStartPos.current = { x: 0, y: 0 }; }, onDrag: (e, info) => handleDrag(e, info, item.id), onDragEnd: () => setDraggingId(null), 
                                        className: `relative ${window.innerWidth > 768 ? '' : 'w-[calc(33.33%-8px)]'} h-32 hover:z-20`, 
                                        style: { touchAction: "none", width: window.innerWidth > 768 ? `calc(${baseWidth}% - 20px)` : undefined } 
                                    },
                                        React.createElement(motion.div, { className: `w-full h-full ${draggingId === item.id ? 'pointer-events-none' : ''}`, whileHover: HOVER_TARGET, whileTap: { scale: 0.95 } },
                                            item.isAddBtn ? (
                                                React.createElement("button", { onClick: () => openLinkModal(), className: "flex flex-col items-center justify-center p-3 glass-panel hover-glow rounded-[1.8rem] border-2 border-dashed border-slate-300/50 dark:border-slate-500/50 text-slate-500 hover:text-blue-500 hover:border-blue-400 w-full h-full transition-colors transition-shadow duration-300", style: { '--glass-opacity': glassSettings.opacity, '--glass-blur': glassSettings.blur + 'px' } }, React.createElement(Plus, { size: 28, className: "mb-1" }), React.createElement("span", { className: "text-xs font-bold" }, "添加"))
                                            ) : (
                                                React.createElement(GlassCard, { 
                                                    ref: { current: { id: item.id } }, 
                                                    isDragging: draggingId === item.id, 
                                                    onPointerDown: (e) => { let clientX, clientY; if (e.touches && e.touches[0]) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; } dragStartPos.current = { x: clientX, y: clientY }; }, 
                                                    onClick: (e) => { let clientX, clientY; if (e.changedTouches && e.changedTouches[0]) { clientX = e.changedTouches[0].clientX; clientY = e.changedTouches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; } const moveX = Math.abs(clientX - dragStartPos.current.x); const moveY = Math.abs(clientY - dragStartPos.current.y); if (moveX < 5 && moveY < 5) { handleLinkClick(item); } }, 
                                                    hoverColor: colors.cardHover, 
                                                    glassSettings: glassSettings, 
                                                    className: `group relative p-3 flex flex-col items-center justify-center text-center cursor-pointer !rounded-[1.8rem] !border-t-4 border-t-transparent glass-card-${item.id} h-full w-full` 
                                                },
                                                    React.createElement("button", { onPointerDown: (e) => e.stopPropagation(), onClick: (e) => { e.stopPropagation(); openLinkModal(item); }, className: "absolute top-1 right-7 p-1.5 text-gray-500 hover:text-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/30 rounded-full opacity-0 group-hover:opacity-100 transition-all scale-75 backdrop-blur-sm z-20" }, React.createElement(Edit3, { size: 14 })),
                                                    React.createElement("button", { onPointerDown: (e) => e.stopPropagation(), onClick: (e) => { e.stopPropagation(); deleteLink(item.id, e); }, className: "absolute top-1 right-1 p-1.5 text-gray-500 hover:text-red-500 hover:bg-red-50/50 dark:hover:bg-red-900/30 rounded-full opacity-0 group-hover:opacity-100 transition-all scale-75 backdrop-blur-sm z-10" }, React.createElement(Trash2, { size: 14 })),
                                                    React.createElement("div", { className: "w-10 h-10 mb-2 rounded-2xl bg-white/20 dark:bg-slate-800/20 p-2 shadow-inner flex items-center justify-center overflow-hidden group-hover:shadow-md transition-all backdrop-blur-sm" }, React.createElement("img", { src: getFavicon(item), alt: item.title, className: "w-full h-full object-contain pointer-events-none rounded-lg", onError: (e) => { if (e.target.src !== 'https://img.icons8.com/ios/50/globe--v1.png') e.target.src = 'https://img.icons8.com/ios/50/globe--v1.png'; } })),
                                                    React.createElement("h3", { className: `font-bold ${bgImage ? 'text-white shadow-text-super' : 'text-slate-800 dark:text-slate-100'} text-xs mb-0.5 w-full truncate pointer-events-none` }, item.title),
                                                    React.createElement("p", { className: `text-[10px] ${bgImage ? 'text-white/80 shadow-text-super' : 'text-slate-600 dark:text-slate-300'} line-clamp-1 w-full opacity-0 group-hover:opacity-100 transition-opacity h-3 font-medium pointer-events-none` }, item.desc)
                                                )
                                            )
                                        )
                                    );
                                })
                            )
                        )
                    ),
                    // Sticky Footer
                    React.createElement("footer", { className: `relative z-10 py-8 text-center ${bgImage ? 'text-white/80 shadow-text-super' : 'text-slate-600 dark:text-slate-400'} text-sm font-bold drop-shadow-sm mt-auto` }, React.createElement("p", null, "© By @AKISATO 2025")),
                    // Settings Modal
                    React.createElement(Modal, { isOpen: showLinkModal, onClose: () => setShowLinkModal(false), title: editingLink ? "编辑收藏" : "添加新网站", glassSettings: glassSettings }, React.createElement("div", { className: "space-y-4" },
                        React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1" }, "网站名称"), React.createElement("input", { type: "text", className: "w-full px-4 py-3 rounded-2xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500 outline-none transition-colors dark:text-white font-bold backdrop-blur-sm", placeholder: "例如: Bilibili", value: linkForm.title, onChange: e => setLinkForm({...linkForm, title: e.target.value}) })),
                        React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1" }, "网址 (URL)"), React.createElement("input", { type: "text", className: "w-full px-4 py-3 rounded-2xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500 outline-none transition-colors dark:text-white font-medium backdrop-blur-sm", placeholder: "例如: bilibili.com", value: linkForm.url, onChange: e => setLinkForm({...linkForm, url: e.target.value}) })),
                        React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1" }, "描述 (可选)"), React.createElement("input", { type: "text", className: "w-full px-4 py-3 rounded-2xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500 outline-none transition-colors dark:text-white font-medium backdrop-blur-sm", placeholder: "一句话描述...", value: linkForm.desc, onChange: e => setLinkForm({...linkForm, desc: e.target.value}) })),
                        React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2" }, "自定义图标 (可选)"), React.createElement("div", { className: "flex gap-2" }, React.createElement("input", { type: "text", className: "flex-1 px-4 py-3 rounded-2xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500 outline-none transition-colors text-xs dark:text-white backdrop-blur-sm", placeholder: "粘贴图片链接...", value: linkForm.iconUrl, onChange: e => setLinkForm({...linkForm, iconUrl: e.target.value}) }), React.createElement("button", { onClick: () => fileInputRef.current.click(), className: "p-3 rounded-2xl bg-blue-50 text-blue-500 hover:bg-blue-100 dark:bg-slate-700 dark:text-blue-400 transition-colors", title: "上传本地图片" }, React.createElement(Upload, { size: 20 })), React.createElement("input", { type: "file", ref: fileInputRef, accept: "image/*", className: "file-input", onChange: (e) => handleFileUpload(e, (url) => setLinkForm(p => ({...p, iconUrl: url}))) })), linkForm.iconUrl && React.createElement("div", { className: "mt-2 flex items-center gap-2" }, React.createElement("span", { className: "text-xs text-slate-500" }, "预览:"), React.createElement("img", { src: linkForm.iconUrl, className: "w-8 h-8 rounded-lg object-contain border border-slate-200 dark:border-slate-600" }), React.createElement("button", { onClick: () => setLinkForm({...linkForm, iconUrl: ''}), className: "text-xs text-red-400 hover:underline" }, "清除"))),
                        React.createElement("button", { onClick: saveLink, className: "w-full py-3 mt-2 bg-gradient-to-r from-blue-500 to-pink-500 text-white rounded-2xl font-black shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transform hover:-translate-y-0.5 transition-all" }, editingLink ? "保存修改" : "确认添加")
                    )),
                    React.createElement(Modal, { isOpen: showSettings, onClose: () => setShowSettings(false), title: "个性化设置", glassSettings: glassSettings }, React.createElement("div", { className: "space-y-8" },
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: User, title: "身份形象" }), React.createElement("div", { className: "space-y-4 bg-white/30 dark:bg-black/20 p-4 rounded-2xl" }, 
                            React.createElement("div", null, React.createElement("label", { className: "settings-label text-xs font-bold text-slate-500 mb-2 block" }, "头像设置"), React.createElement("div", { className: "flex gap-2" }, React.createElement("input", { type: "text", value: avatarUrl, onChange: e => updateAvatar(e.target.value), className: "flex-1 px-3 py-2 rounded-xl bg-white/50 dark:bg-slate-700/50 border border-transparent focus:border-blue-500 outline-none text-xs", placeholder: "头像链接..." }), React.createElement("button", { onClick: () => avatarInputRef.current.click(), className: "p-2 bg-white/50 hover:bg-white rounded-xl" }, React.createElement(Upload, { size: 16 })), React.createElement("input", { type: "file", ref: avatarInputRef, className: "hidden", accept: "image/*", onChange: e => handleFileUpload(e, updateAvatar) }))),
                            React.createElement("div", null, React.createElement("label", { className: "settings-label text-xs font-bold text-slate-500 mb-2 block" }, "网页图标 (Favicon)"), React.createElement("div", { className: "flex gap-2" }, React.createElement("input", { type: "text", value: faviconUrl, onChange: e => updateFavicon(e.target.value), className: "flex-1 px-3 py-2 rounded-xl bg-white/50 dark:bg-slate-700/50 border border-transparent focus:border-blue-500 outline-none text-xs", placeholder: "图标链接..." }), React.createElement("button", { onClick: () => faviconInputRef.current.click(), className: "p-2 bg-white/50 hover:bg-white rounded-xl" }, React.createElement(Upload, { size: 16 })), React.createElement("input", { type: "file", ref: faviconInputRef, className: "hidden", accept: "image/*", onChange: e => handleFileUpload(e, updateFavicon) })))
                        )),
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: Sparkles, title: "视觉特效" }), React.createElement("div", { className: "grid grid-cols-2 gap-3" }, 
                            [{key: 'enableCursor', label: '鼠标光圈', icon: MousePointer}, {key: 'enableParticles', label: '粒子拖尾', icon: Sparkles}, {key: 'enableDynamicBlobs', label: '动态流体背景', icon: Frame}].map(opt => 
                                React.createElement("button", { key: opt.key, onClick: () => updateVisuals(opt.key, !visualSettings[opt.key]), className: `flex items-center gap-2 p-3 rounded-xl transition-all border ${visualSettings[opt.key] ? 'bg-blue-500 text-white border-blue-500 shadow-lg shadow-blue-500/30' : 'bg-white/30 dark:bg-slate-800/30 border-transparent hover:bg-white/50 text-slate-600 dark:text-slate-300'}` }, React.createElement(opt.icon, { size: 16 }), React.createElement("span", { className: "text-xs font-bold" }, opt.label))
                            )
                        )),
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: Layout, title: "布局设置" }), React.createElement("div", { className: "space-y-4 bg-white/30 dark:bg-black/20 p-4 rounded-2xl" }, 
                            React.createElement("div", { className: "flex items-center justify-between" }, React.createElement("span", { className: "settings-label text-xs font-bold text-slate-600 dark:text-slate-300" }, "显示标题"), React.createElement("button", { onClick: () => updateLayout('showTitle', !layoutSettings.showTitle), className: `w-12 h-6 rounded-full p-1 transition-colors ${layoutSettings.showTitle ? 'bg-blue-500' : 'bg-slate-300 dark:bg-slate-600'}` }, React.createElement("div", { className: `w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${layoutSettings.showTitle ? 'translate-x-6' : ''}` }))), 
                            React.createElement("div", { className: "flex gap-2 pt-2 border-t border-slate-200/50 dark:border-white/10" }, React.createElement("div", { className: "flex-1" }, React.createElement("label", { className: "settings-label text-[10px] text-slate-500 mb-1 block" }, "前段文字"), React.createElement("input", { type: "text", className: "w-full px-2 py-1 text-xs text-center rounded-lg bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 outline-none", value: layoutSettings.text1 || 'AKISATO', onChange: (e) => updateLayout('text1', e.target.value) })), React.createElement("div", { className: "w-12" }, React.createElement("label", { className: "settings-label text-[10px] text-slate-500 mb-1 block text-center" }, "连接"), React.createElement("input", { type: "text", maxLength: 4, className: "w-full px-2 py-1 text-xs text-center rounded-lg bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 outline-none", value: layoutSettings.particleText || 'の', onChange: (e) => updateLayout('particleText', e.target.value) })), React.createElement("div", { className: "flex-1" }, React.createElement("label", { className: "settings-label text-[10px] text-slate-500 mb-1 block" }, "后段文字"), React.createElement("input", { type: "text", className: "w-full px-2 py-1 text-xs text-center rounded-lg bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 outline-none", value: layoutSettings.text2 || '灯塔', onChange: (e) => updateLayout('text2', e.target.value) }))), 
                            React.createElement("div", { className: "flex items-center justify-between pt-2 border-t border-slate-200/50 dark:border-white/10" }, React.createElement("span", { className: "settings-label text-xs font-bold text-slate-600 dark:text-slate-300" }, "搜索框位置"), React.createElement("div", { className: "flex bg-slate-200 dark:bg-slate-700/50 rounded-lg p-1" }, [{id:'center', label:'居中', icon: Monitor}, {id:'top', label:'顶部', icon: ArrowUp}].map(pos => React.createElement("button", { key: pos.id, onClick: () => updateLayout('searchPos', pos.id), className: `px-3 py-1 text-[10px] font-bold rounded-md flex items-center gap-1 transition-all ${layoutSettings.searchPos === pos.id ? 'bg-white dark:bg-slate-600 text-blue-500 shadow-sm' : 'text-slate-500 dark:text-slate-400'}` }, React.createElement(pos.icon, { size: 10 }), pos.label)))), 
                            React.createElement("div", { className: "pt-2 border-t border-slate-200/50 dark:border-white/10" },
                                React.createElement("div", { className: "flex items-center justify-between mb-3" }, React.createElement("span", { className: "settings-label text-xs font-bold text-slate-600 dark:text-slate-300" }, "显示我的收藏"), React.createElement("button", { onClick: () => updateLayout('showCollections', !layoutSettings.showCollections), className: `w-12 h-6 rounded-full p-1 transition-colors ${layoutSettings.showCollections ? 'bg-blue-500' : 'bg-slate-300 dark:bg-slate-600'}` }, React.createElement("div", { className: `w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${layoutSettings.showCollections ? 'translate-x-6' : ''}` }))),
                                layoutSettings.showCollections && React.createElement(React.Fragment, null,
                                    React.createElement("div", { className: "mb-2" }, React.createElement("div", { className: "flex justify-between text-xs text-slate-500 mb-1" }, React.createElement("span", null, "卡片大小"), React.createElement("span", null, (layoutSettings.cardSize || 100) + "%")), React.createElement("div", { className: "slider-container" }, React.createElement("input", { type: "range", min: "50", max: "150", step: "5", value: layoutSettings.cardSize || 100, onChange: (e) => updateLayout('cardSize', e.target.value) }))),
                                    React.createElement("div", { className: "mb-2" }, React.createElement("div", { className: "flex justify-between text-xs text-slate-500 mb-1" }, React.createElement("span", null, "卡片间距"), React.createElement("span", null, "Lv." + (layoutSettings.cardGap || 5))), React.createElement("div", { className: "slider-container" }, React.createElement("input", { type: "range", min: "1", max: "10", step: "1", value: layoutSettings.cardGap || 5, onChange: (e) => updateLayout('cardGap', e.target.value) }))),
                                    React.createElement("div", null, 
                                        React.createElement("div", { className: "flex justify-between items-center text-xs text-slate-500 mb-1" }, 
                                            React.createElement("span", { className: "settings-label font-bold" }, `垂直偏移微调 (${isCenterMode ? '居中' : '顶部'})`), 
                                            React.createElement("input", { type: "number", className: "w-16 px-2 py-0.5 text-xs text-right bg-transparent border-b border-slate-300 dark:border-slate-600 outline-none focus:border-blue-500 font-mono", value: currentGridTop, onChange: (e) => updateLayout(isCenterMode ? 'gridTop_center' : 'gridTop_top', Number(e.target.value)) })
                                        ), 
                                        React.createElement("div", { className: "slider-container" }, 
                                            React.createElement("input", { type: "range", min: "0", max: "500", step: "10", value: Math.min(Math.max(currentGridTop, 0), 500), onChange: (e) => updateLayout(isCenterMode ? 'gridTop_center' : 'gridTop_top', Number(e.target.value)) })
                                        )
                                    )
                                )
                            )
                        )),
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: ImageIcon, title: "外观样式" }), React.createElement("div", { className: "space-y-4" }, React.createElement("div", null, React.createElement("label", { className: "settings-label block text-xs font-bold text-slate-700 dark:text-slate-300 mb-2" }, "全局字体"), React.createElement("div", { className: "relative" }, React.createElement("input", { type: "text", value: bodyFont, onChange: (e) => updateBodyFont(e.target.value), className: "w-full px-4 py-2 text-xs rounded-xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500 outline-none font-mono", placeholder: "输入字体名称 (如: Microsoft YaHei)" }))), React.createElement("div", { className: "bg-white/30 dark:bg-black/20 p-4 rounded-2xl" }, React.createElement("label", { className: "settings-label block text-xs font-bold text-slate-700 dark:text-slate-300 mb-3" }, "玻璃拟态效果"), React.createElement("div", { className: "space-y-4" }, React.createElement("div", null, React.createElement("div", { className: "flex justify-between text-xs text-slate-500 mb-2" }, React.createElement("span", null, "透明度"), React.createElement("span", null, Math.round(glassSettings.opacity * 100) + "%")), React.createElement("div", { className: "slider-container" }, React.createElement("input", { type: "range", min: "0.05", max: "0.9", step: "0.05", value: glassSettings.opacity, onChange: (e) => updateGlass('opacity', e.target.value) }))), React.createElement("div", null, React.createElement("div", { className: "flex justify-between text-xs text-slate-500 mb-2" }, React.createElement("span", null, "模糊度"), React.createElement("span", null, glassSettings.blur + "px")), React.createElement("div", { className: "slider-container" }, React.createElement("input", { type: "range", min: "0", max: "60", step: "2", value: glassSettings.blur, onChange: (e) => updateGlass('blur', e.target.value) }))))), React.createElement("div", null, React.createElement("label", { className: "settings-label block text-xs font-bold text-slate-700 dark:text-slate-300 mb-2" }, "背景壁纸"), React.createElement("div", { className: "grid grid-cols-3 gap-3 mb-4" }, PRESET_BGS.map(preset => React.createElement("div", { key: preset.id, onClick: () => updateBg(preset.value), className: `relative aspect-[16/9] rounded-xl overflow-hidden cursor-pointer border-2 transition-all hover:scale-105 ${bgImage === preset.value ? 'border-blue-500 ring-2 ring-blue-200' : 'border-transparent hover:border-gray-300'}` }, preset.previewColor ? React.createElement("div", { className: `w-full h-full ${preset.previewColor}` }) : React.createElement("img", { src: preset.value, className: "w-full h-full object-cover" }), bgImage === preset.value && React.createElement("div", { className: "absolute inset-0 bg-blue-500/20 flex items-center justify-center" }, React.createElement("div", { className: "bg-blue-500 rounded-full p-1" }, React.createElement(Check, { size: 12, className: "text-white" }))), React.createElement("div", { className: "absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-1 text-center font-bold" }, preset.name)))), React.createElement("div", { className: "flex flex-col gap-2" }, React.createElement("div", { className: "flex gap-2" }, React.createElement("input", { type: "text", className: "flex-1 px-4 py-3 rounded-2xl bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-pink-500 outline-none transition-colors text-xs dark:text-white backdrop-blur-sm", value: bgImage, onChange: e => updateBg(e.target.value), placeholder: "图片直链..." }), React.createElement("button", { onClick: () => bgFileInputRef.current.click(), className: "p-3 rounded-2xl bg-blue-50 text-blue-500 hover:bg-blue-100 dark:bg-slate-700 dark:text-blue-400 transition-colors shrink-0", title: "上传本地壁纸" }, React.createElement(Upload, { size: 20 }))), React.createElement("input", { type: "file", ref: bgFileInputRef, accept: "image/*", className: "file-input", onChange: (e) => handleFileUpload(e, updateBg) }))))),
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: Search, title: "搜索引擎" }), React.createElement("div", { className: "grid grid-cols-3 gap-2" }, SEARCH_ENGINES.map(engine => React.createElement("button", { key: engine.id, onClick: () => setDefaultEngine(engine), className: `flex flex-col items-center justify-center p-2 rounded-xl transition-all ${searchEngine.id === engine.id ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 text-blue-600 dark:text-blue-300' : 'bg-white/20 dark:bg-slate-800/40 border border-slate-200/50 dark:border-slate-600 text-slate-500 hover:bg-white/40'}` }, React.createElement(engine.logo, { className: "w-6 h-6 mb-1" }), React.createElement("span", { className: "text-xs font-bold" }, engine.name))))),
                        React.createElement("div", null, React.createElement(SectionHeader, { icon: Palette, title: "主题颜色" }), React.createElement("div", { className: "space-y-6" }, React.createElement("div", null, React.createElement("div", { className: "text-[10px] text-slate-400 font-bold mb-2 uppercase tracking-wider" }, "首页视觉元素"), React.createElement("div", { className: "grid grid-cols-3 gap-4 bg-white/30 dark:bg-black/20 p-4 rounded-2xl" }, React.createElement(ColorPicker, { color: colors.searchBtn, label: "搜索按钮", onChange: (val) => updateColor('searchBtn', val) }), React.createElement(ColorPicker, { color: colors.blobLeft, label: "左侧光晕", onChange: (val) => updateColor('blobLeft', val) }), React.createElement(ColorPicker, { color: colors.blobRight, label: "右侧光晕", onChange: (val) => updateColor('blobRight', val) }), React.createElement(ColorPicker, { color: colors.title1, label: "标题前段", onChange: (val) => updateColor('title1', val) }), React.createElement(ColorPicker, { color: colors.particle, label: "连接词", onChange: (val) => updateColor('particle', val) }), React.createElement(ColorPicker, { color: colors.title2, label: "标题后段", onChange: (val) => updateColor('title2', val) }), React.createElement(ColorPicker, { color: colors.cardHover, label: "卡片悬停/主题色", onChange: (val) => updateColor('cardHover', val) }))), React.createElement("div", null, React.createElement("div", { className: "text-[10px] text-slate-400 font-bold mb-2 uppercase tracking-wider" }, "界面文字"), React.createElement("div", { className: "grid grid-cols-3 gap-4 bg-white/30 dark:bg-black/20 p-4 rounded-2xl" }, React.createElement(ColorPicker, { color: colors.textColor, label: "全局主色", onChange: (val) => updateColor('textColor', val) }), React.createElement(ColorPicker, { color: colors.subTextColor, label: "次要文字", onChange: (val) => updateColor('subTextColor', val) }), React.createElement(ColorPicker, { color: colors.modalTitleColor, label: "弹窗标题", onChange: (val) => updateColor('modalTitleColor', val) }), React.createElement(ColorPicker, { color: colors.sectionTitleColor, label: "分组标题", onChange: (val) => updateColor('sectionTitleColor', val) }), React.createElement(ColorPicker, { color: colors.labelColor, label: "选项标签", onChange: (val) => updateColor('labelColor', val) }))))),
                        React.createElement("div", { className: "pt-4 border-t border-slate-200 dark:border-slate-700" }, 
                            React.createElement("button", { onClick: resetSettings, className: "w-full py-3 flex items-center justify-center gap-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-2xl transition-colors font-bold" }, React.createElement(RotateCcw, { size: 16 }), "重置所有数据"),
                            React.createElement(BusuanziStats)
                        )
                    ))
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>